<!-- Round End Modal (z-[60] to be above navbar) -->
<dialog id="round-end-modal" class="modal modal-open z-[60]">
    <div class="modal-box max-w-2xl">
        <!-- Header with Buttons -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm opacity-70">Round {{ round_number }}/{{ total_rounds }}</div>
            <h3 class="text-xl font-bold">Round Complete!</h3>
            <button class="btn btn-primary btn-sm" onclick="continueToNextRound()" id="continue-btn">
                {% if is_final_round %}Results{% else %}Next{% endif %} â†’
            </button>
        </div>

        <!-- Word Reveal Banner -->
        <div class="bg-gradient-to-r from-primary/20 to-primary/10 rounded-lg p-4 mb-4 text-center">
            <div class="text-xs opacity-70 uppercase font-medium mb-1">The word was</div>
            <div class="text-3xl font-bold text-primary">{{ word }}</div>
            <div class="text-xs opacity-50 mt-1">Drawn by {{ drawer_name }}</div>
        </div>

        <!-- Round Scores - Compact -->
        <div class="mb-4">
            <h4 class="font-bold text-xs mb-2 opacity-70">Points This Round</h4>
            <div class="space-y-1 max-h-40 overflow-y-auto">
                {% for player in round_scores %}
                <div class="flex items-center gap-2 py-1.5 px-2 rounded text-sm {% if player.points_earned > 0 %}bg-success/10 border-l-2 border-success{% else %}bg-base-200{% endif %}">
                    <span class="w-6 text-center text-xs font-medium opacity-70">{{ loop.index }}</span>
                    <span class="flex-1 font-medium truncate">{{ player.name }}</span>
                    <span class="text-xs opacity-60">
                        {% if player.guess_time %}{{ player.guess_time }}s{% elif player.is_drawer %}Artist{% else %}-{% endif %}
                    </span>
                    {% if player.points_earned > 0 %}
                    <span class="font-bold text-success">+{{ player.points_earned }}</span>
                    {% else %}
                    <span class="font-bold opacity-30">0</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Current Standings - Top 3 -->
        <div class="mb-3">
            <h4 class="font-bold text-xs mb-2 opacity-70">Current Standings</h4>
            <div class="flex gap-6 justify-center">
                {% for player in leaderboard[:3] %}
                <div class="text-center">
                    <div class="text-2xl mb-1">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% else %}ðŸ¥‰{% endif %}</div>
                    <div class="font-medium text-sm truncate max-w-20">{{ player.name }}</div>
                    <div class="font-bold">{{ player.total_score }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Auto-continue countdown -->
        <div class="text-center">
            <div class="text-xs opacity-50">
                Auto-continuing in <span id="auto-continue-timer" class="font-bold">10</span>s
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button disabled>close</button>
    </form>
</dialog>

<script>
(function() {
    const modal = document.getElementById('round-end-modal');
    const timerEl = document.getElementById('auto-continue-timer');
    const roomId = '{{ room_id }}';
    const isFinalRound = {{ is_final_round|lower }};

    let timeLeft = 10;
    window._roundEndTimerInterval = setInterval(function() {
        if (window.isReloading) {
            clearInterval(window._roundEndTimerInterval);
            return;
        }

        timeLeft--;
        if (timerEl) {
            timerEl.textContent = timeLeft;
        }

        if (timeLeft <= 0) {
            clearInterval(window._roundEndTimerInterval);
            continueToNextRound();
        }
    }, 1000);

    window.continueToNextRound = function() {
        if (window.isReloading) return;

        clearInterval(window._roundEndTimerInterval);

        if (modal) modal.close();

        if (isFinalRound) {
            htmx.ajax('GET', `/canvas-clash/rooms/${roomId}/partials/game_over`, {
                target: '#game-modals',
                swap: 'innerHTML'
            });
        } else {
            const modalsContainer = document.getElementById('game-modals');
            if (modalsContainer) modalsContainer.innerHTML = '';
        }
    };
})();
</script>
