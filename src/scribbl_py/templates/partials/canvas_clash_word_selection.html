<!-- Word Selection Modal -->
<dialog id="word-selection-modal" class="modal modal-open">
    <div class="modal-box max-w-2xl">
        <h3 class="text-2xl font-bold text-center mb-2">Choose a Word to Draw</h3>
        <p class="text-center text-base-content/70 mb-6">Select one of the following words</p>

        <!-- Word Options -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for word in word_options %}
            <button
                class="card bg-base-200 hover:bg-primary hover:text-primary-content transition-all duration-200 transform hover:scale-105 cursor-pointer border-2 border-transparent hover:border-primary"
                onclick="selectWord('{{ word }}')"
            >
                <div class="card-body items-center text-center p-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    <h4 class="card-title text-2xl font-bold">{{ word }}</h4>
                </div>
            </button>
            {% endfor %}
        </div>

        <!-- Timer -->
        <div class="text-center mt-6">
            <div class="text-sm opacity-70 mb-2">Choose quickly!</div>
            <div class="radial-progress text-primary" style="--value:100; --size:3rem;" id="word-selection-timer">
                <span class="text-sm font-bold" id="word-selection-seconds">10</span>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button disabled>close</button>
    </form>
</dialog>

<script>
(function() {
    const modal = document.getElementById('word-selection-modal');
    const timerProgress = document.getElementById('word-selection-timer');
    const timerSeconds = document.getElementById('word-selection-seconds');
    const roomId = '{{ room_id }}';

    let timeLeft = 10;
    let timerInterval = setInterval(function() {
        timeLeft--;
        timerSeconds.textContent = timeLeft;
        const progress = (timeLeft / 10) * 100;
        timerProgress.style.setProperty('--value', progress);

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            // Auto-select first word if time runs out
            selectWord('{{ word_options[0] }}');
        }
    }, 1000);

    // Word selection function - uses WebSocket to broadcast to all players
    window.selectWord = function(word) {
        clearInterval(timerInterval);

        // Send selection via WebSocket (gameWs is global from game template)
        if (typeof gameWs !== 'undefined' && gameWs && gameWs.readyState === WebSocket.OPEN) {
            console.log('[Word Selection] Sending word via WebSocket:', word);
            gameWs.send(JSON.stringify({
                type: 'select_word',
                word: word
            }));

            // Close modal
            if (modal) {
                modal.close();
            }

            // Update UI to show selected word
            const wordDisplay = document.getElementById('word-display');
            if (wordDisplay) {
                wordDisplay.textContent = word;
            }
        } else {
            // Fallback to REST if WebSocket not available
            console.log('[Word Selection] WebSocket not available, using REST');
            fetch(`/canvas-clash/rooms/${roomId}/select-word`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ word: word })
            }).then(response => {
                if (response.ok) {
                    if (modal) {
                        modal.close();
                    }
                    const wordDisplay = document.getElementById('word-display');
                    if (wordDisplay) {
                        wordDisplay.textContent = word;
                    }
                }
            }).catch(error => {
                console.error('Error selecting word:', error);
            });
        }
    };
})();
</script>
