<!-- Game Over Modal (z-[60] to be above navbar) -->
<dialog id="game-over-modal" class="modal modal-open z-[60]">
    <div class="modal-box max-w-2xl">
        <!-- Header with Buttons -->
        <div class="flex items-center justify-between mb-4">
            <button class="btn btn-outline btn-sm" onclick="leaveLobby()">
                ‚Üê Home
            </button>
            <h3 class="text-2xl font-bold">Game Over!</h3>
            <button class="btn btn-primary btn-sm" onclick="playAgain()">
                Play Again ‚Üí
            </button>
        </div>

        <!-- Winner Banner -->
        {% if final_scores|length >= 1 %}
        <div class="bg-gradient-to-r from-warning/30 to-warning/10 rounded-lg p-4 mb-4 flex items-center justify-center gap-4">
            <span class="text-4xl">üèÜ</span>
            <div class="text-center">
                <div class="text-xs opacity-70 uppercase">Winner</div>
                <div class="font-bold text-xl">{{ final_scores[0].name }}</div>
                <div class="text-sm font-medium">{{ final_scores[0].score }} points</div>
            </div>
            <span class="text-4xl">üèÜ</span>
        </div>
        {% endif %}

        <!-- Final Standings -->
        <div class="mb-4">
            <h4 class="font-bold text-xs mb-2 opacity-70">Final Standings</h4>
            <!-- Top 5 always visible -->
            <div class="space-y-1 text-sm">
                {% for player in final_scores[:5] %}
                <div class="flex items-center gap-2 py-1.5 px-2 rounded {% if loop.index <= 3 %}bg-base-200{% endif %}">
                    <span class="w-6 text-center font-bold">
                        {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                    </span>
                    <span class="flex-1 font-medium truncate">{{ player.name }}</span>
                    <span class="font-bold">{{ player.score }}</span>
                </div>
                {% endfor %}
            </div>
            <!-- Expandable rest of players -->
            {% if final_scores|length > 5 %}
            <details class="mt-1">
                <summary class="text-xs opacity-60 cursor-pointer hover:opacity-100 py-1">
                    +{{ final_scores|length - 5 }} more players...
                </summary>
                <div class="space-y-1 text-sm max-h-32 overflow-y-auto">
                    {% for player in final_scores[5:] %}
                    <div class="flex items-center gap-2 py-1.5 px-2">
                        <span class="w-6 text-center text-xs opacity-70">{{ loop.index + 5 }}</span>
                        <span class="flex-1 truncate opacity-80">{{ player.name }}</span>
                        <span class="text-xs opacity-70">{{ player.score }}</span>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>

        <!-- Game Stats -->
        <div class="flex justify-center gap-8 text-center">
            <div>
                <div class="font-bold text-xl text-primary">{{ game_stats.total_rounds }}</div>
                <div class="text-xs opacity-70">Rounds</div>
            </div>
            <div>
                <div class="font-bold text-xl text-secondary">{{ final_scores|length }}</div>
                <div class="text-xs opacity-70">Players</div>
            </div>
            <div>
                <div class="font-bold text-xl text-accent">{{ game_stats.total_guesses or 0 }}</div>
                <div class="text-xs opacity-70">Guesses</div>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button disabled>close</button>
    </form>
</dialog>

<!-- Confetti container -->
<div id="game-over-confetti" class="fixed inset-0 pointer-events-none z-[59]"></div>

<style>
.confetti-piece {
    position: absolute;
    width: 10px;
    height: 10px;
    animation: confetti-fall 4s ease-out forwards;
}
@keyframes confetti-fall {
    0% {
        opacity: 1;
        transform: translateY(-10px) rotate(0deg);
    }
    100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
    }
}
</style>

<script>
(function() {
    const roomId = '{{ room_id }}';

    // Launch confetti!
    function launchConfetti() {
        const container = document.getElementById('game-over-confetti');
        if (!container) return;

        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1'];
        const shapes = ['circle', 'square', 'triangle'];

        for (let i = 0; i < 100; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.top = '-10px';
            piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDelay = Math.random() * 2 + 's';
            piece.style.animationDuration = (3 + Math.random() * 2) + 's';

            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            if (shape === 'circle') {
                piece.style.borderRadius = '50%';
            } else if (shape === 'triangle') {
                piece.style.width = '0';
                piece.style.height = '0';
                piece.style.backgroundColor = 'transparent';
                piece.style.borderLeft = '5px solid transparent';
                piece.style.borderRight = '5px solid transparent';
                piece.style.borderBottom = '10px solid ' + colors[Math.floor(Math.random() * colors.length)];
            }

            container.appendChild(piece);
        }

        // Clean up after animation
        setTimeout(() => {
            container.innerHTML = '';
        }, 6000);
    }

    // Launch confetti on load
    launchConfetti();

    window.playAgain = function() {
        fetch(`/canvas-clash/rooms/${roomId}/reset`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    window.location.href = `/canvas-clash/rooms/${roomId}/lobby`;
                }
            })
            .catch(error => console.error('Error resetting game:', error));
    };

    window.leaveLobby = function() {
        window.location.href = '/';
    };
})();
</script>
